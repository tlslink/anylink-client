name: Build AnyLink Client for Windows

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 1. 检出代码
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: 2. 安装Qt 5.15.2
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        host: 'windows'
        target: 'desktop'
        arch: 'win64_msvc2019_64'
        
    -name: 3. 检查文件
      shell: cmd  # 指定使用CMD而不是PowerShell
      run: |
        echo === 文件检查 ===
        echo 当前目录:
        cd
        echo 文件列表:
        dir
        echo anylink.pro 是否存在:
        if exist anylink.pro (
          echo ✅ 找到anylink.pro
          type anylink.pro | head -5
        ) else (
          echo ❌ 未找到anylink.pro
          echo 所有文件:
          dir /s /b *.pro 2>nul || echo 无.pro文件
  )
        
    - name: 4. 运行qmake
      run: |
        echo "=== 运行qmake ==="
        set PATH=C:\Qt\5.15.2\msvc2019_64\bin;%PATH%
        qmake --version
        qmake anylink.pro CONFIG+=release
        echo "qmake完成"
        
    - name: 5. 编译
      run: |
        echo "=== 开始编译 ==="
        nmake || echo "编译失败"
        
    - name: 6. 检查结果
      run: |
        echo "=== 检查结果 ==="
        if exist release\*.exe (
          echo "✅ 编译成功！找到exe文件:"
          dir release\*.exe
        ) else (
          echo "❌ 未找到exe文件"
          echo "release目录:"
          dir release 2>nul || echo "无release目录"
        )
        
    - name: 7. 上传产物
      if: success()
      uses: actions/upload-artifact@v4
      with:
        name: anylink-windows
        path: release/
