name: Build AnyLink Client for Windows

on:
  workflow_dispatch:  # 仅手动触发，便于调试
  push:
    branches: [main]

jobs:
  build-windows:
    runs-on: windows-latest
    
    strategy:
      matrix:
        config:
          - { qt: '5.15.2', arch: 'win64_msvc2019_64', spec: 'win32-msvc' }
          # 先只保留一个配置，调试成功后再添加其他
    
    steps:
    - name: 检出代码和子模块
      uses: actions/checkout@v3
      with:
        submodules: recursive
        fetch-depth: 0
    
    - name: 安装Qt ${{ matrix.config.qt }}
      uses: jurplel/install-qt-action@v3
      id: install-qt
      with:
        version: ${{ matrix.config.qt }}
        host: 'windows'
        target: 'desktop'
        arch: ${{ matrix.config.arch }}
        cache: true
        tools: 'tools_cmake,tools_ninja'
    
    - name: 显示Qt安装信息
      run: |
        echo "Qt路径: ${{ steps.install-qt.outputs.qt-path }}"
        echo "Qt版本: ${{ steps.install-qt.outputs.qt-version }}"
        dir "${{ steps.install-qt.outputs.qt-path }}\bin"
    
    - name: 设置MSVC环境 (仅MSVC需要)
      if: contains(matrix.config.arch, 'msvc')
      uses: microsoft/setup-msbuild@v1.1
    
    - name: 检查项目结构
      run: |
        echo "当前目录内容:"
        dir
        echo "3rdparty目录:"
        dir 3rdparty 2>nul || echo "3rdparty目录不存在或为空"
        echo "项目文件:"
        dir *.pro
    
    - name: 配置项目 (qmake)
      run: |
        echo "设置PATH..."
        set PATH=${{ steps.install-qt.outputs.qt-path }}\bin;%PATH%
        echo "运行qmake..."
        qmake --version
        qmake anylink.pro -spec ${{ matrix.config.spec }} CONFIG+=release
        echo "生成的文件:"
        dir *.mak *.vcxproj 2>nul || echo "未找到项目文件"
    
    - name: 编译项目
      run: |
        echo "开始编译..."
        if exist Makefile (
          echo "使用make编译..."
          make || nmake || echo "编译失败"
        ) else if exist *.sln (
          echo "使用MSBuild编译..."
          msbuild anylink.sln /p:Configuration=Release
        ) else (
          echo "未找到编译文件，尝试直接运行nmake..."
          nmake 2>&1 || echo "nmake失败"
        )
    
    - name: 检查编译结果
      run: |
        echo "检查输出文件..."
        if exist release (
          echo "release目录内容:"
          dir release
          if exist release\*.exe (
            echo "✅ 成功生成exe文件!"
          ) else (
            echo "❌ 未找到exe文件"
          )
        ) else (
          echo "release目录不存在"
        )
        
        if exist debug (
          echo "debug目录内容:"
          dir debug
        )
    
    - name: 上传编译产物
      if: success()
      uses: actions/upload-artifact@v3
      with:
        name: anylink-windows-${{ matrix.config.qt }}-${{ matrix.config.arch }}
        path: |
          release/*.exe
          debug/*.exe
        retention-days: 7
