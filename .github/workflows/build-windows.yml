name: Build AnyLink Client for Windows

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: windows-latest
    
    steps:
    - name: 1. 检出代码和子模块
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: 2. 安装Qt
      uses: jurplel/install-qt-action@v3
      with:
        version: '5.15.2'
        arch: 'win64_msvc2019_64'
        
    - name: 3. 设置MSVC编译环境
      uses: microsoft/setup-msbuild@v1.3
      with:
        vs-version: '2022'
        
    - name: 4. 检查文件
      shell: cmd
      run: |
        echo 检查文件...
        dir
        if exist anylink.pro (
          echo 找到anylink.pro文件
        ) else (
          echo 错误：未找到anylink.pro
          exit 1
        )
        
    - name: 5. 测试编译器
      shell: cmd
      run: |
        echo 测试cl编译器...
        cl 2>&1 | head -5
        echo 测试qmake...
        qmake --version
        
    - name: 6. 生成Makefile
      shell: cmd
      run: |
        echo 运行qmake...
        qmake anylink.pro CONFIG+=release
        
    - name: 7. 编译
      shell: cmd
      run: |
        echo 开始编译...
        nmake
        
    - name: 8. 检查结果
      shell: cmd
      run: |
        echo 检查编译结果...
        if exist release\*.exe (
          echo ✅ 编译成功！
          echo 生成的文件：
          dir release\*.exe /b
          echo 文件大小：
          for %%f in (release\*.exe) do echo %%f - %%~zf bytes
        ) else (
          echo ❌ 编译失败，未生成exe文件
          echo 当前目录内容：
          dir
          echo release目录内容：
          dir release 2>nul || echo 无release目录
          exit 1
        )
    
    # 暂时注释掉上传步骤，先确保编译成功
    # - name: 9. 上传产物
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: anylink-client-windows
    #     path: release\*.exe
