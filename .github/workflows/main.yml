name: Build Complete AnyLink Windows Package

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build-windows:
    runs-on: ubuntu-latest
    
    steps:
    - name: 1. æ£€å‡ºä»£ç å’Œå­æ¨¡å—
      uses: actions/checkout@v4
      with:
        submodules: recursive
        fetch-depth: 0
        
    - name: 2. ä½¿ç”¨Mxeäº¤å‰ç¼–è¯‘ç¯å¢ƒï¼ˆæ›´ç¨³å®šï¼‰
      run: |
        echo "=== ä½¿ç”¨MXEäº¤å‰ç¼–è¯‘ç¯å¢ƒ ==="
        
        # åˆ›å»ºDockerç¼–è¯‘ç¯å¢ƒ
        cat > Dockerfile.mxe << 'EOF'
        FROM dockcross/windows-shared-x64
        
        # å®‰è£…Qt5 for Windows
        RUN apt-get update && apt-get install -y \
            wget git cmake make \
            qt5-qmake qtbase5-dev \
            g++-mingw-w64-x86-64 \
            mingw-w64 \
            libqt5core5a libqt5gui5 libqt5network5 \
            && rm -rf /var/lib/apt/lists/*
            
        # è®¾ç½®Qtäº¤å‰ç¼–è¯‘ç¯å¢ƒ
        ENV MXE_PATH=/usr/lib/mxe
        ENV PATH=$MXE_PATH/usr/bin:$PATH
        EOF
        
        docker build -f Dockerfile.mxe -t mxe-qt-builder .
        
        echo "=== å¼€å§‹ç¼–è¯‘ ==="
        docker run --rm -v $(pwd):/workdir \
          -w /workdir \
          mxe-qt-builder \
          bash -c "
            echo 'è®¾ç½®äº¤å‰ç¼–è¯‘ç¯å¢ƒ...'
            export CC=x86_64-w64-mingw32.shared-gcc
            export CXX=x86_64-w64-mingw32.shared-g++
            export AR=x86_64-w64-mingw32.shared-ar
            export PKG_CONFIG_PATH=/usr/x86_64-w64-mingw32/lib/pkgconfig
            
            echo 'æ£€æŸ¥é¡¹ç›®...'
            ls -la
            if [ ! -f anylink.pro ]; then
              echo 'é”™è¯¯ï¼šæ‰¾ä¸åˆ°anylink.pro'
              exit 1
            fi
            
            echo '=== ç¬¬ä¸€æ­¥ï¼šç”ŸæˆMakefile ==='
            # ä½¿ç”¨äº¤å‰ç¼–è¯‘çš„qmake
            x86_64-w64-mingw32.shared-qmake-qt5 anylink.pro \
              -spec win32-g++ \
              CONFIG+=release \
              CONFIG+=static
            
            echo '=== ç¬¬äºŒæ­¥ï¼šç¼–è¯‘é¡¹ç›® ==='
            make -j4
            
            echo '=== ç¬¬ä¸‰æ­¥ï¼šæ£€æŸ¥è¾“å‡º ==='
            if [ -f release/anylink.exe ]; then
              echo 'âœ… ç¼–è¯‘æˆåŠŸï¼'
              echo 'æ–‡ä»¶ä¿¡æ¯ï¼š'
              file release/anylink.exe
              ls -lh release/anylink.exe
            else
              echo 'æŸ¥æ‰¾exeæ–‡ä»¶...'
              find . -name '*.exe' -type f
              exit 1
            fi
          "
        
    - name: 3. æ”¶é›†è¿è¡Œæ—¶ä¾èµ–ï¼ˆå…³é”®æ­¥éª¤ï¼‰
      run: |
        echo "=== æ”¶é›†è¿è¡Œæ—¶DLL ==="
        
        # åˆ›å»ºéƒ¨ç½²ç›®å½•
        mkdir -p AnyLinkDeploy
        
        # æŸ¥æ‰¾exeæ–‡ä»¶
        EXE_FILE=$(find . -name "*.exe" -type f | grep -i anylink | head -1)
        
        if [ -z "$EXE_FILE" ]; then
          EXE_FILE=$(find . -name "*.exe" -type f | head -1)
        fi
        
        if [ -n "$EXE_FILE" ]; then
          echo "æ‰¾åˆ°EXE: $EXE_FILE"
          cp "$EXE_FILE" AnyLinkDeploy/
          
          # ä½¿ç”¨objdumpæŸ¥æ‰¾ä¾èµ–
          echo "åˆ†æä¾èµ–..."
          docker run --rm -v $(pwd):/workdir \
            dockcross/windows-shared-x64 \
            bash -c "
              cd /workdir
              echo 'åˆ†æ$EXE_FILEçš„ä¾èµ–...'
              x86_64-w64-mingw32.shared-objdump -p AnyLinkDeploy/*.exe | grep 'DLL Name:' | sort -u
              
              # å¸¸è§Qtä¾èµ–
              QT_DLLS='libgcc_s_seh-1 libstdc++-6 libwinpthread-1 Qt5Core Qt5Gui Qt5Widgets Qt5Network'
              
              echo 'å¤åˆ¶å¿…éœ€çš„DLL...'
              for dll in \$QT_DLLS; do
                echo 'æŸ¥æ‰¾: '\$dll.dll'
                find /usr -name \"\${dll}.dll\" 2>/dev/null | head -1 | xargs -I {} cp {} AnyLinkDeploy/ 2>/dev/null || true
              done
            "
          
          echo "éƒ¨ç½²ç›®å½•å†…å®¹:"
          ls -la AnyLinkDeploy/
        else
          echo "âŒ æœªæ‰¾åˆ°exeæ–‡ä»¶"
          exit 1
        fi
        
    - name: 4. åˆ›å»ºWindowsè¿è¡Œç¯å¢ƒ
      run: |
        echo "=== åˆ›å»ºå®Œæ•´è¿è¡ŒåŒ… ==="
        
        # åˆ›å»ºå¿…è¦çš„Windowsç›®å½•ç»“æ„
        mkdir -p AnyLinkComplete
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
        cp -r AnyLinkDeploy/* AnyLinkComplete/ 2>/dev/null || true
        
        # åˆ›å»ºè¿è¡Œè„šæœ¬
        cat > AnyLinkComplete/è¿è¡Œè¯´æ˜.txt << 'EOF'
        AnyLinkå®¢æˆ·ç«¯ä½¿ç”¨è¯´æ˜
        ====================
        
        ä½¿ç”¨æ–¹æ³•ï¼š
        1. è§£å‹æ­¤æ–‡ä»¶å¤¹åˆ°ä»»æ„ä½ç½®ï¼ˆä¸è¦åªæå–exeæ–‡ä»¶ï¼ï¼‰
        2. åŒå‡» anylink.exe è¿è¡Œ
        
        å¦‚æœæ— æ³•è¿è¡Œï¼Œè¯·å°è¯•ï¼š
        1. å®‰è£… Visual C++ è¿è¡Œæ—¶ï¼š
           https://aka.ms/vs/17/release/vc_redist.x64.exe
        2. ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ
        3. æ£€æŸ¥æ˜¯å¦è¢«é˜²ç«å¢™/æ€æ¯’è½¯ä»¶æ‹¦æˆª
        
        æ–‡ä»¶è¯´æ˜ï¼š
        - anylink.exeï¼šä¸»ç¨‹åº
        - Qt5*.dllï¼šQtè¿è¡Œåº“
        - lib*.dllï¼šMinGWè¿è¡Œåº“
        
        è”ç³»æ”¯æŒï¼š
        - é¡¹ç›®åœ°å€ï¼šhttps://github.com/hnqychen2008/anylink-client
        EOF
        
        # åˆ›å»ºæ‰¹å¤„ç†æµ‹è¯•è„šæœ¬
        cat > AnyLinkComplete/æµ‹è¯•è¿è¡Œ.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        echo ================================
        echo AnyLinkå®¢æˆ·ç«¯ç¯å¢ƒæµ‹è¯•
        echo ================================
        echo.
        
        if exist anylink.exe (
            echo âœ… æ‰¾åˆ°ä¸»ç¨‹åº: anylink.exe
            echo æ–‡ä»¶å¤§å°: %~z0 bytes
        ) else (
            echo âŒ é”™è¯¯ï¼šæ‰¾ä¸åˆ°anylink.exe
            goto :error
        )
        
        echo.
        echo æ£€æŸ¥ä¾èµ–DLL:
        set DLL_COUNT=0
        for %%d in (Qt5Core Qt5Gui Qt5Widgets Qt5Network) do (
            if exist %%d.dll (
                echo âœ… %%d.dll å­˜åœ¨
                set /a DLL_COUNT+=1
            ) else (
                echo âŒ %%d.dll ç¼ºå¤±
            )
        )
        
        echo.
        if %DLL_COUNT% == 4 (
            echo âœ… æ‰€æœ‰å¿…éœ€DLLéƒ½å­˜åœ¨
            echo.
            echo è¿è¡Œæµ‹è¯•...ï¼ˆæŒ‰Ctrl+Cå–æ¶ˆï¼‰
            timeout /t 3
            echo.
            echo æ­£åœ¨å¯åŠ¨AnyLink...
            start anylink.exe
        ) else (
            echo âš ï¸ éƒ¨åˆ†DLLç¼ºå¤±ï¼Œç¨‹åºå¯èƒ½æ— æ³•è¿è¡Œ
        )
        
        :error
        echo.
        pause
        exit /b
        EOF
        
        # åˆ›å»ºå‹ç¼©åŒ…
        zip -r AnyLink_Client_Complete_Windows.zip AnyLinkComplete/
        
        echo "âœ… æ‰“åŒ…å®Œæˆï¼"
        ls -lh AnyLink_Client_Complete_Windows.zip
        
    - name: 5. ä¸Šä¼ å®Œæ•´åŒ…
      uses: actions/upload-artifact@v4
      with:
        name: AnyLink-Windows-Complete-Package
        path: |
          AnyLink_Client_Complete_Windows.zip
          AnyLinkComplete/
        retention-days: 30
        
    - name: 6. ç”Ÿæˆä¸‹è½½é“¾æ¥
      run: |
        echo "=== ç¼–è¯‘å®Œæˆ ==="
        echo "âœ… AnyLink Windowså®¢æˆ·ç«¯å·²æˆåŠŸæ„å»ºï¼"
        echo ""
        echo "ğŸ“¦ ä¸‹è½½é“¾æ¥å°†åœ¨å·¥ä½œæµå®Œæˆåå‡ºç°åœ¨å³ä¾§ArtifactsåŒºåŸŸ"
        echo ""
        echo "ä½¿ç”¨æ–¹æ³•ï¼š"
        echo "1. ä¸‹è½½ AnyLink_Client_Complete_Windows.zip"
        echo "2. è§£å‹æ•´ä¸ªæ–‡ä»¶å¤¹ï¼ˆä¸è¦åªæå–exeï¼‰"
        echo "3. åŒå‡» æµ‹è¯•è¿è¡Œ.bat æˆ– anylink.exe"
        echo ""
        echo "å¦‚æœä»æœ‰é—®é¢˜ï¼Œè¯·æ£€æŸ¥ï¼š"
        echo "- æ˜¯å¦å®‰è£…äº† Visual C++ è¿è¡Œæ—¶"
        echo "- æ˜¯å¦ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
        echo "- Windowsç‰ˆæœ¬æ˜¯å¦ä¸ºWindows 10/11"
