name: Build AnyLink Windows Client - Complete Edition

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
    # ç¬¬ä¸€é˜¶æ®µï¼šå‡†å¤‡çŽ¯å¢ƒ
    - name: 1. æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        submodules: recursive
        
    - name: 2. è®¾ç½®MXE Qtäº¤å‰ç¼–è¯‘çŽ¯å¢ƒ
      run: |
        echo "è®¾ç½®MXEï¼ˆM cross environmentï¼‰äº¤å‰ç¼–è¯‘çŽ¯å¢ƒ..."
        
        # å…‹éš†MXEï¼ˆQt Windowsäº¤å‰ç¼–è¯‘å·¥å…·é“¾ï¼‰
        git clone https://github.com/mxe/mxe.git mxe-build
        cd mxe-build
        
        # å®‰è£…Qt5å’Œå¿…è¦çš„å·¥å…·é“¾ï¼ˆè¿™ä¼šèŠ±ä¸€äº›æ—¶é—´ï¼‰
        echo "å®‰è£…Qt5å·¥å…·é“¾ï¼ˆçº¦10-15åˆ†é’Ÿï¼‰..."
        make qt5 -j4 JOBS=4
        
        echo "MXEå®‰è£…å®Œæˆï¼"
        ls usr/x86_64-w64-mingw32.shared/bin/qt5/
        
    # ç¬¬äºŒé˜¶æ®µï¼šç¼–è¯‘é¡¹ç›®
    - name: 3. é…ç½®å’Œç¼–è¯‘AnyLink
      run: |
        echo "=== å¼€å§‹ç¼–è¯‘AnyLink ==="
        
        # è®¾ç½®äº¤å‰ç¼–è¯‘çŽ¯å¢ƒå˜é‡
        export PATH="$(pwd)/mxe-build/usr/bin:$PATH"
        export MXE_TARGET="x86_64-w64-mingw32.shared"
        
        cd anylink-client
        
        echo "1. æ£€æŸ¥é¡¹ç›®ç»“æž„..."
        ls -la
        echo "anylink.proå†…å®¹é¢„è§ˆï¼š"
        head -30 anylink.pro
        
        echo "2. ä½¿ç”¨MXEçš„qmake..."
        # MXEæä¾›çš„Windows qmake
        x86_64-w64-mingw32.shared-qmake-qt5 anylink.pro \
          CONFIG+=release \
          CONFIG+=static
        
        echo "3. ç¼–è¯‘..."
        make -j4
        
        echo "4. æ£€æŸ¥è¾“å‡º..."
        if [ -f release/anylink.exe ]; then
          echo "âœ… ç¼–è¯‘æˆåŠŸï¼"
          file release/anylink.exe
          ls -lh release/anylink.exe
          
          # å¤åˆ¶åˆ°æ ¹ç›®å½•
          cp release/anylink.exe ../
        else
          echo "æŸ¥æ‰¾exeæ–‡ä»¶..."
          find . -name "*.exe" -type f
        fi
        
    # ç¬¬ä¸‰é˜¶æ®µï¼šæ‰“åŒ…å¯æ‰§è¡Œæ–‡ä»¶
    - name: 4. æ”¶é›†è¿è¡Œæ—¶ä¾èµ–
      run: |
        echo "=== æ”¶é›†è¿è¡Œæ—¶åº“ ==="
        
        mkdir -p AnyLinkPortable
        
        # å¤åˆ¶exe
        if [ -f anylink.exe ]; then
          cp anylink.exe AnyLinkPortable/
          echo "ä¸»ç¨‹åºå·²å¤åˆ¶"
        fi
        
        # ä½¿ç”¨MXEçš„windeployqtæ”¶é›†ä¾èµ–
        echo "æ”¶é›†Qtè¿è¡Œæ—¶åº“..."
        cd mxe-build
        
        # æŸ¥æ‰¾windeployqt
        WINDEPLOYQT=$(find . -name "windeployqt" -type f | head -1)
        
        if [ -n "$WINDEPLOYQT" ]; then
          echo "ä½¿ç”¨windeployqtæ”¶é›†ä¾èµ–..."
          $WINDEPLOYQT ../AnyLinkPortable/anylink.exe \
            --no-compiler-runtime \
            --no-system-d3d-compiler \
            --no-opengl-sw \
            --no-angle \
            --no-translations
        else
          echo "æ‰‹åŠ¨å¤åˆ¶å¿…éœ€DLL..."
          # æ‰‹åŠ¨å¤åˆ¶å…³é”®DLL
          cp usr/x86_64-w64-mingw32.shared/bin/{Qt5Core,Qt5Gui,Qt5Widgets,Qt5Network}.dll ../AnyLinkPortable/ 2>/dev/null || true
          cp usr/x86_64-w64-mingw32.shared/bin/{libgcc_s_seh-1,libstdc++-6,libwinpthread-1}.dll ../AnyLinkPortable/ 2>/dev/null || true
        fi
        
        cd ..
        
        echo "Portableç›®å½•å†…å®¹ï¼š"
        ls -la AnyLinkPortable/
        
    - name: 5. åˆ›å»ºWindowså¯åŠ¨åŒ…
      run: |
        echo "=== åˆ›å»ºWindowsè¿è¡ŒåŒ… ==="
        
        # åˆ›å»ºå¿…è¦çš„ç›®å½•ç»“æž„
        mkdir -p FinalPackage
        
        # å¤åˆ¶æ‰€æœ‰æ–‡ä»¶
        cp -r AnyLinkPortable/* FinalPackage/
        
        # åˆ›å»ºè¿è¡Œè„šæœ¬
        cat > FinalPackage/Run_AnyLink.bat << 'EOF'
        @echo off
        chcp 65001 >nul
        title AnyLinkå®¢æˆ·ç«¯
        
        echo ========================================
        echo      AnyLink SSL VPN å®¢æˆ·ç«¯
        echo ========================================
        echo.
        
        if not exist anylink.exe (
            echo é”™è¯¯ï¼šæ‰¾ä¸åˆ° anylink.exe
            echo è¯·ç¡®ä¿å°†æ­¤batæ–‡ä»¶ä¸Žanylink.exeæ”¾åœ¨åŒä¸€ç›®å½•
            pause
            exit /b 1
        )
        
        echo æ£€æŸ¥è¿è¡ŒçŽ¯å¢ƒ...
        
        set ERROR=0
        
        REM æ£€æŸ¥å¿…éœ€DLL
        for %%d in (Qt5Core Qt5Gui Qt5Widgets Qt5Network) do (
            if not exist %%d.dll (
                echo [é”™è¯¯] ç¼ºå°‘ %%d.dll
                set ERROR=1
            )
        )
        
        if %ERROR% equ 1 (
            echo.
            echo è§£å†³æ–¹æ³•ï¼š
            echo 1. ç¡®ä¿è§£åŽ‹äº†æ‰€æœ‰æ–‡ä»¶ï¼ˆä¸è¦åªæå–exeï¼‰
            echo 2. å®‰è£… Visual C++ è¿è¡Œæ—¶åº“
            echo 3. ä»Ž https://github.com/hnqychen2008/anylink-client é‡æ–°ä¸‹è½½å®Œæ•´åŒ…
            pause
            exit /b 1
        )
        
        echo.
        echo çŽ¯å¢ƒæ£€æŸ¥é€šè¿‡ï¼
        echo æ­£åœ¨å¯åŠ¨ AnyLink...
        echo.
        
        REM ä»¥ç®¡ç†å‘˜æƒé™è¿è¡Œï¼ˆå¦‚æžœéœ€è¦ï¼‰
        anylink.exe
        
        pause
        EOF
        
        # åˆ›å»ºè¯´æ˜Žæ–‡ä»¶
        cat > FinalPackage/README_CN.txt << 'EOF'
        AnyLinkå®¢æˆ·ç«¯ - ä½¿ç”¨è¯´æ˜Ž
        =========================
        
        ç‰ˆæœ¬ï¼šGitHub Actionsè‡ªåŠ¨æž„å»ºç‰ˆ
        æ—¥æœŸï¼š$(date +%Y-%m-%d)
        
        å¿«é€Ÿå¼€å§‹ï¼š
        1. å°†æœ¬æ–‡ä»¶å¤¹è§£åŽ‹åˆ°ä»»æ„ä½ç½®ï¼ˆå¦‚æ¡Œé¢ï¼‰
        2. åŒå‡» Run_AnyLink.bat å¯åŠ¨ç¨‹åº
        3. æˆ–ç›´æŽ¥åŒå‡» anylink.exe
        
        ç³»ç»Ÿè¦æ±‚ï¼š
        - Windows 10 æˆ–æ›´é«˜ç‰ˆæœ¬
        - éœ€è¦å®‰è£… Visual C++ Redistributable
          ä¸‹è½½ï¼šhttps://aka.ms/vs/17/release/vc_redist.x64.exe
        
        å¸¸è§é—®é¢˜ï¼š
        
        1. æç¤º"ç¼ºå°‘Qt5Core.dll"ç­‰é”™è¯¯
           åŽŸå› ï¼šæ²¡æœ‰å®Œæ•´è§£åŽ‹æ–‡ä»¶å¤¹
           è§£å†³ï¼šé‡æ–°è§£åŽ‹æ•´ä¸ªZIPæ–‡ä»¶
        
        2. ç¨‹åºé—ªé€€
           åŽŸå› ï¼šå¯èƒ½æ˜¯æƒé™é—®é¢˜
           è§£å†³ï¼šå³é”®"ä»¥ç®¡ç†å‘˜èº«ä»½è¿è¡Œ"
        
        3. æ— æ³•è¿žæŽ¥VPNæœåŠ¡å™¨
           åŽŸå› ï¼šé˜²ç«å¢™æˆ–ç½‘ç»œè®¾ç½®
           è§£å†³ï¼šæ£€æŸ¥æœåŠ¡å™¨åœ°å€å’Œç«¯å£
        
        æ–‡ä»¶è¯´æ˜Žï¼š
        - anylink.exeï¼šä¸»ç¨‹åº
        - Qt5*.dllï¼šQtè¿è¡Œåº“
        - lib*.dllï¼šMinGWè¿è¡Œåº“
        - Run_AnyLink.batï¼šå¯åŠ¨è„šæœ¬
        
        æŠ€æœ¯æ”¯æŒï¼š
        - é¡¹ç›®åœ°å€ï¼šhttps://github.com/hnqychen2008/anylink-client
        - åŽŸé¡¹ç›®ï¼šhttps://github.com/tlslink/anylink-client
        
        å…è´£å£°æ˜Žï¼š
        æœ¬è½¯ä»¶æŒ‰åŽŸæ ·æä¾›ï¼Œä½¿ç”¨é£Žé™©è‡ªè´Ÿã€‚
        EOF
        
        # åˆ›å»ºZIPåŽ‹ç¼©åŒ…
        zip -r AnyLink_Windows_Client.zip FinalPackage/
        
        echo "âœ… æ‰“åŒ…å®Œæˆï¼"
        echo "æ–‡ä»¶å¤§å°ï¼š"
        ls -lh AnyLink_Windows_Client.zip
        
    - name: 6. ä¸Šä¼ æœ€ç»ˆæˆæžœ
      uses: actions/upload-artifact@v4
      with:
        name: AnyLink-Windows-Final
        path: |
          AnyLink_Windows_Client.zip
          FinalPackage/
        retention-days: 30
        
    - name: 7. æ¸…ç†å’Œæ€»ç»“
      run: |
        echo "=== æž„å»ºå®Œæˆ ==="
        echo ""
        echo "ðŸŽ‰ AnyLink Windowså®¢æˆ·ç«¯å·²æˆåŠŸæž„å»ºï¼"
        echo ""
        echo "ðŸ“¥ ä¸‹è½½ï¼š"
        echo "åœ¨å·¥ä½œæµè¿è¡Œå®ŒæˆåŽï¼Œå³ä¾§ArtifactsåŒºåŸŸä¸‹è½½ AnyLink_Windows_Client.zip"
        echo ""
        echo "ðŸ“‹ ä½¿ç”¨æ–¹æ³•ï¼š"
        echo "1. ä¸‹è½½ AnyLink_Windows_Client.zip"
        echo "2. è§£åŽ‹åˆ°ä»»æ„æ–‡ä»¶å¤¹ï¼ˆå¦‚æ¡Œé¢ï¼‰"
        echo "3. åŒå‡» Run_AnyLink.bat æˆ– anylink.exe"
        echo ""
        echo "ðŸ”§ åŒ…å«æ–‡ä»¶ï¼š"
        echo "â€¢ anylink.exe - ä¸»ç¨‹åº"
        echo "â€¢ Qt5*.dll - Qtè¿è¡Œåº“"
        echo "â€¢ lib*.dll - C++è¿è¡Œåº“"
        echo "â€¢ Run_AnyLink.bat - è‡ªåŠ¨æ£€æµ‹å¯åŠ¨è„šæœ¬"
        echo "â€¢ README_CN.txt - è¯¦ç»†è¯´æ˜Ž"
        echo ""
        echo "âš ï¸  æ³¨æ„ï¼š"
        echo "â€¢ å¿…é¡»è§£åŽ‹æ•´ä¸ªæ–‡ä»¶å¤¹ï¼Œä¸è¦åªæå–exe"
        echo "â€¢ é¦–æ¬¡è¿è¡Œå¯èƒ½éœ€è¦å®‰è£…VC++è¿è¡Œæ—¶åº“"
        echo "â€¢ Windows Defenderå¯èƒ½è¯¯æŠ¥ï¼Œè¯·æ·»åŠ ä¿¡ä»»"
